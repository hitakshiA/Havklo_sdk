<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kraken SDK - Browser Demo</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #7c3aed;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #888;
            margin-bottom: 30px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .card {
            background: #16161d;
            border: 1px solid #2a2a35;
            border-radius: 12px;
            padding: 20px;
        }
        .card h2 {
            color: #a78bfa;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }
        .status.connected {
            background: #22c55e;
        }
        .status.synced {
            background: #3b82f6;
        }
        .price-display {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin: 10px 0;
        }
        .price-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .spread {
            color: #f59e0b;
        }
        .orderbook {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .orderbook-side h3 {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .level {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .bids .level {
            background: rgba(34, 197, 94, 0.1);
        }
        .asks .level {
            background: rgba(239, 68, 68, 0.1);
        }
        .level .price {
            color: #fff;
        }
        .level .qty {
            color: #888;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat {
            background: #1e1e28;
            padding: 12px;
            border-radius: 8px;
        }
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 500;
            color: #fff;
            margin-top: 4px;
        }
        .l3-section {
            margin-top: 20px;
        }
        .l3-section h3 {
            font-size: 14px;
            color: #a78bfa;
            margin-bottom: 10px;
        }
        .queue-info {
            background: #1e1e28;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }
        .queue-info .row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        .queue-info .label {
            color: #888;
        }
        .queue-info .value {
            color: #fff;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        button {
            background: #7c3aed;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        button:hover {
            background: #6d28d9;
        }
        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }
        button.secondary {
            background: #374151;
        }
        button.secondary:hover {
            background: #4b5563;
        }
        .log {
            background: #0d0d12;
            border: 1px solid #2a2a35;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 2px 0;
            color: #888;
        }
        .log-entry.info {
            color: #3b82f6;
        }
        .log-entry.success {
            color: #22c55e;
        }
        .log-entry.error {
            color: #ef4444;
        }
        .log-entry .time {
            color: #4b5563;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kraken SDK Browser Demo</h1>
        <p class="subtitle">Real-time orderbook streaming with WebAssembly</p>

        <div class="controls">
            <button id="connectBtn" onclick="connect()">Connect to Kraken</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled class="secondary">Disconnect</button>
        </div>

        <div class="grid">
            <!-- L2 Orderbook Card -->
            <div class="card">
                <h2>
                    <span class="status" id="l2Status"></span>
                    BTC/USD L2 Orderbook
                </h2>

                <div class="price-label">Mid Price</div>
                <div class="price-display" id="midPrice">--</div>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Best Bid</div>
                        <div class="stat-value" id="bestBid" style="color: #22c55e;">--</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Best Ask</div>
                        <div class="stat-value" id="bestAsk" style="color: #ef4444;">--</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Spread</div>
                        <div class="stat-value spread" id="spread">--</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Spread (bps)</div>
                        <div class="stat-value spread" id="spreadBps">--</div>
                    </div>
                </div>

                <div class="orderbook" style="margin-top: 20px;">
                    <div class="orderbook-side bids">
                        <h3>Bids</h3>
                        <div id="bids"></div>
                    </div>
                    <div class="orderbook-side asks">
                        <h3>Asks</h3>
                        <div id="asks"></div>
                    </div>
                </div>
            </div>

            <!-- L3 Orderbook Card -->
            <div class="card">
                <h2>
                    <span class="status" id="l3Status"></span>
                    BTC/USD L3 Orderbook (Simulated)
                </h2>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" id="totalOrders">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Imbalance</div>
                        <div class="stat-value" id="imbalance">0.00</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">VWAP (Buy 1 BTC)</div>
                        <div class="stat-value" id="vwapBuy">--</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">VWAP (Sell 1 BTC)</div>
                        <div class="stat-value" id="vwapSell">--</div>
                    </div>
                </div>

                <div class="l3-section">
                    <h3>Your Order Queue Position</h3>
                    <div class="queue-info" id="queueInfo">
                        <div class="row">
                            <span class="label">Order ID</span>
                            <span class="value" id="queueOrderId">--</span>
                        </div>
                        <div class="row">
                            <span class="label">Position</span>
                            <span class="value" id="queuePosition">--</span>
                        </div>
                        <div class="row">
                            <span class="label">Quantity Ahead</span>
                            <span class="value" id="queueQtyAhead">--</span>
                        </div>
                        <div class="row">
                            <span class="label">Fill Probability</span>
                            <span class="value" id="queueFillProb">--</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <button onclick="placeSimulatedOrder()">Simulate Order Placement</button>
                </div>
            </div>

            <!-- Event Log Card -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Event Log</h2>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import WASM module
        import init, { WasmOrderbook, WasmL3Book } from '../../pkg/kraken_wasm.js';

        let ws = null;
        let l2Book = null;
        let l3Book = null;
        let simulatedOrderId = null;
        let orderCounter = 0;

        // Make functions available globally
        window.connect = connect;
        window.disconnect = disconnect;
        window.placeSimulatedOrder = placeSimulatedOrder;

        // Initialize WASM
        async function initWasm() {
            try {
                await init();
                log('WASM module loaded successfully', 'success');

                // Create L2 orderbook
                l2Book = new WasmOrderbook('BTC/USD');
                l2Book.enable_history(50);
                log('L2 Orderbook initialized', 'info');

                // Create L3 orderbook (simulated)
                l3Book = new WasmL3Book('BTC/USD', 100);
                log('L3 Orderbook initialized', 'info');

            } catch (e) {
                log(`Failed to initialize WASM: ${e}`, 'error');
            }
        }

        function connect() {
            if (ws) return;

            log('Connecting to Kraken WebSocket...', 'info');
            ws = new WebSocket('wss://ws.kraken.com/v2');

            ws.onopen = () => {
                log('Connected to Kraken', 'success');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('l2Status').classList.add('connected');

                // Subscribe to BTC/USD orderbook
                ws.send(JSON.stringify({
                    method: 'subscribe',
                    params: {
                        channel: 'book',
                        symbol: ['BTC/USD'],
                        depth: 10
                    }
                }));
                log('Subscribed to BTC/USD book (depth=10)', 'info');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    // Skip heartbeats and status messages
                    if (data.channel === 'heartbeat' || data.channel === 'status') {
                        return;
                    }

                    // Apply message to L2 book
                    l2Book.apply_message(event.data);

                    // Update UI if synced
                    if (l2Book.is_synced()) {
                        document.getElementById('l2Status').classList.add('synced');
                        updateL2Display();

                        // Simulate L3 based on L2 data
                        simulateL3FromL2();
                    }

                    // Log snapshots
                    if (data.type === 'snapshot') {
                        log(`Received orderbook snapshot`, 'success');
                    }

                } catch (e) {
                    // Ignore parse errors for non-JSON messages
                }
            };

            ws.onclose = () => {
                log('Disconnected from Kraken', 'info');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('l2Status').classList.remove('connected', 'synced');
                ws = null;
            };

            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function updateL2Display() {
            const mid = l2Book.get_mid_price();
            const spread = l2Book.get_spread();
            const bids = l2Book.get_bids();
            const asks = l2Book.get_asks();

            // Update prices
            document.getElementById('midPrice').textContent = mid ? `$${mid.toFixed(2)}` : '--';
            document.getElementById('spread').textContent = spread ? `$${spread.toFixed(2)}` : '--';

            if (mid && spread) {
                const spreadBps = (spread / mid) * 10000;
                document.getElementById('spreadBps').textContent = `${spreadBps.toFixed(1)} bps`;
            }

            if (bids.length > 0) {
                document.getElementById('bestBid').textContent = `$${bids[0].price.toFixed(2)}`;
            }
            if (asks.length > 0) {
                document.getElementById('bestAsk').textContent = `$${asks[0].price.toFixed(2)}`;
            }

            // Update orderbook display
            const bidsHtml = bids.slice(0, 5).map(level =>
                `<div class="level">
                    <span class="price">$${level.price.toFixed(2)}</span>
                    <span class="qty">${level.qty.toFixed(4)}</span>
                </div>`
            ).join('');

            const asksHtml = asks.slice(0, 5).map(level =>
                `<div class="level">
                    <span class="price">$${level.price.toFixed(2)}</span>
                    <span class="qty">${level.qty.toFixed(4)}</span>
                </div>`
            ).join('');

            document.getElementById('bids').innerHTML = bidsHtml;
            document.getElementById('asks').innerHTML = asksHtml;
        }

        function simulateL3FromL2() {
            if (!l2Book.is_synced()) return;

            const bids = l2Book.get_bids();
            const asks = l2Book.get_asks();

            // Clear and rebuild L3 book from L2 data (simulation)
            // In real usage, L3 data would come from Kraken's L3 feed

            // Add simulated orders at each price level
            bids.forEach((level, i) => {
                const orderId = `sim_bid_${i}`;
                try {
                    l3Book.add_order(orderId, 'bid', level.price.toString(), level.qty.toString());
                } catch (e) {
                    // Order might already exist
                }
            });

            asks.forEach((level, i) => {
                const orderId = `sim_ask_${i}`;
                try {
                    l3Book.add_order(orderId, 'ask', level.price.toString(), level.qty.toString());
                } catch (e) {
                    // Order might already exist
                }
            });

            // Update L3 display
            updateL3Display();
        }

        function updateL3Display() {
            document.getElementById('l3Status').classList.add('synced');

            const totalOrders = l3Book.order_count();
            const imbalance = l3Book.get_imbalance();
            const vwapBuy = l3Book.get_vwap_ask('1.0');
            const vwapSell = l3Book.get_vwap_bid('1.0');

            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('imbalance').textContent = imbalance ? imbalance.toFixed(3) : '0.00';
            document.getElementById('vwapBuy').textContent = vwapBuy ? `$${vwapBuy.toFixed(2)}` : '--';
            document.getElementById('vwapSell').textContent = vwapSell ? `$${vwapSell.toFixed(2)}` : '--';

            // Update queue position if we have a simulated order
            if (simulatedOrderId) {
                const queuePos = l3Book.get_queue_position(simulatedOrderId);
                if (queuePos) {
                    document.getElementById('queueOrderId').textContent = simulatedOrderId;
                    document.getElementById('queuePosition').textContent = `${queuePos.position} of ${queuePos.total_orders}`;
                    document.getElementById('queueQtyAhead').textContent = queuePos.qty_ahead.toFixed(4);
                    document.getElementById('queueFillProb').textContent = `${(queuePos.fill_probability * 100).toFixed(1)}%`;
                }
            }
        }

        function placeSimulatedOrder() {
            if (!l2Book || !l2Book.is_synced()) {
                log('Cannot place order: orderbook not synced', 'error');
                return;
            }

            const bids = l2Book.get_bids();
            if (bids.length === 0) return;

            // Place order at best bid
            const bestBid = bids[0].price;
            simulatedOrderId = `my_order_${++orderCounter}`;

            try {
                l3Book.add_order(simulatedOrderId, 'bid', bestBid.toString(), '0.5');
                log(`Placed simulated order: ${simulatedOrderId} @ $${bestBid.toFixed(2)}`, 'success');
                updateL3Display();
            } catch (e) {
                log(`Failed to place order: ${e}`, 'error');
            }
        }

        function log(message, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="time">${time}</span>${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Initialize on page load
        initWasm();
    </script>
</body>
</html>
